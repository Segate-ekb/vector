# Чтение из файлов.
[sources.input_logs]
  type = "file"
  include = ['''/var/log/logtj/**/*.log''']
  data_dir =  '''/var/lib/vector'''
  fingerprint.strategy = "device_and_inode"
  multiline.timeout_ms = 1000
  multiline.mode = "halt_before"
  multiline.start_pattern = ''
  multiline.condition_pattern = '[0-5]{1}\d:[0-5]{1}\d.'

# Базовая трансформация, выделение вида события, длительности и тд. 
[transforms.remap_logs]
inputs = ["input_logs"]
type = "remap"
file = "/etc/vector/transforms/parseLog.vrl"

# СЕКЦИЯ СОБЫТИЙ
# Каждое событие ТЖ обрабатывается отдельно 
# Для обработки необходимо создать фильтр по событию и ремап со ссылкой на vrl файл c описанием транформации

# Событие EXCP
[transforms.filter_EXCP] 
  inputs = ["remap_logs"]
  type = "filter"
  condition = '.Event == "EXCP"'

[transforms.EXCP]
inputs = ["filter_EXCP"]
type = "remap"
file = "/etc/vector/transforms/EXCP.vrl"

# Событие EXCPCNTX
[transforms.filter_EXCPCNTX] 
  inputs = ["remap_logs"]
  type = "filter"
  condition = '.Event == "EXCPCNTX"'

[transforms.EXCPCNTX]
inputs = ["filter_EXCPCNTX"]
type = "remap"
file = "/etc/vector/transforms/EXCPCNTX.vrl"

# Событие EXCPCNTX
[transforms.filter_DBMSSQL] 
  inputs = ["remap_logs"]
  type = "filter"
  condition = '.Event == "DBMSSQL"'

[transforms.DBMSSQL]
inputs = ["filter_DBMSSQL"]
type = "remap"
file = "/etc/vector/transforms/DBMSSQL.vrl"

# Все остальные события
[transforms.filter_other] 
  inputs = ["remap_logs"]
  type = "filter"
  condition = '.Event != "EXCPCNTX" && .Event != "EXCP" && .Event != "DBMSSQL"'

# СЕКЦИЯ ВЫВОДА ДАННЫХ
# В данной секции описываются все используемые методы вывода обработанных логов
# 
[sinks.EXCP_json_out]
type = "file"
inputs = [ "EXCP" ]
compression = "none"
path = "/tmp/excp/EXCP-%Y-%m-%d %H:%M.json"

  
  [sinks.EXCP_json_out.encoding]
  codec = "json"

#[sinks.cl_excp]
#  type = "clickhouse"
#  inputs = ["EXCP"]
#  endpoint = '''192.168.1.53:8123'''
#  auth.strategy = "basic"
#  auth.user = '''default'''
#  auth.password = ''''''
#  database = '''tj'''
#  table = '''excp'''
#  skip_unknown_fields = true
#  encoding.timestamp_format = "unix"
#  batch.max_events = 10000
#  batch.timeout_secs = 5
#  acknowledgements.enabled = true